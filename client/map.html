<!DOCTYPE html>
<html style="height:100%;margin:0px 0px">
    <meta charset="UTF-8">
    <script src="api.js"></script>
    <head>
        <script src="https://maps.googleapis.com/maps/api/js"></script>
        <script type="text/javascript">
            var markers = []
            var place_ids = []
            var map
            var radius = 1.0
            var lastLatLong = new google.maps.LatLng(15.0, 15.0)
            
            function onMarkerClick(event)
            {
                for (var i = 0; i < markers.length; i++)
                {
                    if (event.latLng.equals(markers[i].getPosition()))
                    {
                        console.log("Clicked " + place_ids[i] + "!")
                    }
                }    
            }
            
            function initializeMap()
            {
                if (!(lastLatLong.equals(map.getCenter())))
                {
                    for (var i = 0; i < markers.length; i++)
                    {
                        markers[i].setMap(null)
                    }
                    
                    markers = []
                    place_ids = []
                    
                    places = searchPlaces(map.getCenter().lng(),
                                          map.getCenter().lat(),
                                          radius)
                    
                    for (var i = 0; i < places.length; i++)
                    {
                        var place = places[i]
                        
                        var marker = new google.maps.Marker({position: new google.maps.LatLng(place.latitude,
                                                                                              place.longitude),
                                                             map: map,
                                                             title: place.label});
                        
                        marker.addListener("click", onMarkerClick)
                        
                        markers.push(marker)
                        
                        place_ids.push(place.id)
                    }
                    
                    lastLatLong = map.getCenter()
                }
                
                setTimeout("initializeMap()", 1000)
            }
            
            function init()
            {
                var prop = {center:new google.maps.LatLng(0.0, 0.0),
                            zoom:10,
                            mapTypeId:google.maps.MapTypeId.ROADMAP}

                map = new google.maps.Map(document.getElementById("GoogleMap"), prop)
                
                initializeMap()
            }
            
            google.maps.event.addDomListener(window, "load", init);
        </script>
    </head>
    <body style="height:100%;margin:0px 0px">
        <div id="GoogleMap" style="width:100%;height:100%;margin:0px 0px"/>
    </body>
</html>
